<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GradeMaster</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                900: '#0c4a6e',
              }
            }
          }
        }
      }
    </script>

    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React and Icons -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0"
  }
}
</script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased selection:bg-brand-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Calculator, LayoutGrid, Settings, Book, ArrowRight, Calendar, LogOut, 
        ShieldCheck, Plus, Trash2, BookOpen, Edit2, Layout, ArrowLeft, Save, 
        Lock, Users, UserPlus, ChevronLeft, Search, GraduationCap, TrendingUp, 
        AlertCircle, LogIn, Shield, Check, X, ShieldAlert, Archive, RotateCcw,
        Database, Download, Upload, Mail, Send, Info, ExternalLink, Copy
      } from 'lucide-react';

      // --- HELPERS ---
      let _uniqueIdCounter = 0;
      const generateId = () => {
        _uniqueIdCounter++;
        return Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9) + '-' + _uniqueIdCounter;
      };

      const APP_URL = "https://frazncc.github.io/GradeMaster/";

      const sortUnits = (units) => {
        return [...units].sort((a, b) => {
           const getNum = (str) => {
             const unitMatch = str.match(/Unit\s+(\d+)/i);
             if (unitMatch) return parseInt(unitMatch[1], 10);
             const aMatch = str.match(/^A(\d+)/i);
             if (aMatch) return parseInt(aMatch[1], 10);
             return 9999;
           };
           const nA = getNum(a.name);
           const nB = getNum(b.name);
           if (nA !== nB) return nA - nB;
           return a.name.localeCompare(b.name);
        });
      };

      // --- TYPES & ENUMS ---

      const QualificationType = {
        EXTENDED_CERTIFICATE: "Extended Certificate (360 GLH)",
        FOUNDATION_DIPLOMA: "Foundation Diploma (510/540 GLH)",
        DIPLOMA: "Diploma (720 GLH)",
        EXTENDED_DIPLOMA: "Extended Diploma (1080 GLH)",
        L2_AWARD: "Level 2 Award (120 GLH)",
        L2_CERTIFICATE: "Level 2 Certificate (240 GLH)",
        L2_EXTENDED_CERTIFICATE: "Level 2 Extended Certificate (360 GLH)",
        L2_DIPLOMA: "Level 2 Diploma (480 GLH)",
        L1_INTRO_DIPLOMA: "Level 1 Introductory Diploma (360 GLH)"
      };

      const Subject = {
        ESPORTS: "Esports",
        IT: "Information Technology",
        COMPUTING: "Computing",
        ICT_L2: "Information & Creative Tech (Level 2)",
        VOCATIONAL_L1: "Vocational Studies (Level 1)"
      };

      const UnitType = {
        INTERNAL: "Internal",
        EXTERNAL: "External"
      };

      const Grade = {
        U: "U",
        NP: "NP",
        P: "P",
        M: "M",
        D: "D",
        L1P: "L1P",
        L2P: "L2P",
        L2M: "L2M",
        L2D: "L2D"
      };

      const UserRole = {
        SUPERUSER: "Superuser",
        ADMIN: "Admin",
        TEACHER: "Teacher"
      };

      // --- SERVICES ---
      
      const getAvailableGrades = (qualType) => {
          if (qualType.startsWith("Level 2")) {
              return [Grade.U, Grade.L1P, Grade.L2P, Grade.L2M, Grade.L2D];
          }
          if (qualType.startsWith("Level 1")) {
              return [Grade.U, Grade.P, Grade.M, Grade.D];
          }
          return [Grade.U, Grade.NP, Grade.P, Grade.M, Grade.D];
      };

      const calculatePointsForUnit = (unit, qualType) => {
        const { glh, type, grade } = unit;
        let table = {
          60: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.NP]: 0, [Grade.P]: 6, [Grade.M]: 10, [Grade.D]: 16 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.NP]: 4, [Grade.P]: 6, [Grade.M]: 10, [Grade.D]: 16 } },
          90: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.NP]: 0, [Grade.P]: 9, [Grade.M]: 15, [Grade.D]: 24 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.NP]: 6, [Grade.P]: 9, [Grade.M]: 15, [Grade.D]: 24 } },
          120: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.NP]: 0, [Grade.P]: 12, [Grade.M]: 20, [Grade.D]: 32 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.NP]: 12, [Grade.P]: 20, [Grade.M]: 32, [Grade.D]: 48 } }
        };
        
        if (qualType.startsWith("Level 2")) {
            table = {
              30: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.L1P]: 6, [Grade.L2P]: 12, [Grade.L2M]: 18, [Grade.L2D]: 24 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.L1P]: 6, [Grade.L2P]: 12, [Grade.L2M]: 18, [Grade.L2D]: 24 } },
              60: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.L1P]: 12, [Grade.L2P]: 24, [Grade.L2M]: 36, [Grade.L2D]: 48 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.L1P]: 12, [Grade.L2P]: 24, [Grade.L2M]: 36, [Grade.L2D]: 48 } },
              120: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.L1P]: 24, [Grade.L2P]: 48, [Grade.L2M]: 72, [Grade.L2D]: 96 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.L1P]: 24, [Grade.L2P]: 48, [Grade.L2M]: 72, [Grade.L2D]: 96 } }
            };
        } else if (qualType.startsWith("Level 1")) {
            table = {
              30: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.P]: 5, [Grade.M]: 10, [Grade.D]: 15 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.P]: 5, [Grade.M]: 10, [Grade.D]: 15 } },
              60: { [UnitType.INTERNAL]: { [Grade.U]: 0, [Grade.P]: 10, [Grade.M]: 20, [Grade.D]: 30 }, [UnitType.EXTERNAL]: { [Grade.U]: 0, [Grade.P]: 10, [Grade.M]: 20, [Grade.D]: 30 } }
            };
        }

        if (table[glh] && table[glh][type] && table[glh][type][grade] !== undefined) {
          return table[glh][type][grade];
        }
        return 0;
      };

      const calculateQualification = (units, qualType) => {
        const totalPoints = units.reduce((sum, unit) => sum + calculatePointsForUnit(unit, qualType), 0);
        const boundaries = {
          [QualificationType.EXTENDED_CERTIFICATE]: [ { minPoints: 36, grade: "P", ucas: 16 }, { minPoints: 52, grade: "M", ucas: 32 }, { minPoints: 74, grade: "D", ucas: 48 }, { minPoints: 90, grade: "D*", ucas: 56 } ],
          [QualificationType.EXTENDED_DIPLOMA]: [ { minPoints: 108, grade: "PPP", ucas: 48 }, { minPoints: 124, grade: "MPP", ucas: 64 }, { minPoints: 140, grade: "MMP", ucas: 80 }, { minPoints: 156, grade: "MMM", ucas: 96 }, { minPoints: 176, grade: "DMM", ucas: 112 }, { minPoints: 196, grade: "DDM", ucas: 128 }, { minPoints: 216, grade: "DDD", ucas: 144 }, { minPoints: 234, grade: "D*DD", ucas: 152 }, { minPoints: 252, grade: "D*D*D", ucas: 160 }, { minPoints: 270, grade: "D*D*D*", ucas: 168 } ]
        };
        const activeBoundaries = boundaries[qualType] || [];
        let achievedGrade = "U";
        let achievedUcas = 0;
        let nextBoundary = undefined;

        for (let i = 0; i < activeBoundaries.length; i++) {
          const b = activeBoundaries[i];
          if (totalPoints >= b.minPoints) { achievedGrade = b.grade; achievedUcas = b.ucas; }
          else { nextBoundary = { grade: b.grade, pointsNeeded: b.minPoints - totalPoints }; break; }
        }
        return { totalPoints, grade: achievedGrade, ucasPoints: achievedUcas, nextGradeBoundary: nextBoundary };
      };

      const mergeUnitsAndGrades = (templates, studentGrades = {}, lockedGrades = {}) => {
        return templates.map(template => ({
          ...template,
          grade: studentGrades?.[template.id] || Grade.U,
          isLocked: !!lockedGrades?.[template.id]
        }));
      };

      // --- COMPONENTS ---

      const ResultsPanel = ({ results, variant = 'default' }) => {
        if (variant === 'compact') {
            return (
                <div className="flex items-center space-x-6 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 shadow-sm">
                    <div className="flex items-center border-r border-slate-200 pr-6">
                        <div className="text-right mr-3">
                            <div className="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Grade</div>
                            <div className="text-2xl font-extrabold text-brand-600 leading-none">{results.grade}</div>
                        </div>
                        <div className="text-brand-500 opacity-80"><TrendingUp size={20} /></div>
                    </div>
                    <div className="flex items-center space-x-6">
                        <div><div className="text-[10px] text-slate-500 uppercase font-semibold">UCAS</div><div className="text-lg font-bold text-slate-700 leading-none">{results.ucasPoints}</div></div>
                        <div><div className="text-[10px] text-slate-500 uppercase font-semibold">Points</div><div className="text-lg font-bold text-slate-700 leading-none">{results.totalPoints}</div></div>
                    </div>
                </div>
            );
        }
        return (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 h-full flex flex-col">
            <h2 className="text-xl font-bold text-slate-900 mb-6 flex items-center"><TrendingUp className="w-5 h-5 mr-2 text-brand-500" />Projected Outcome</h2>
            <div className="bg-brand-50 p-4 rounded-lg border border-brand-100 mb-4"><div className="text-sm text-brand-600 mb-1">Projected Grade</div><div className="text-4xl font-extrabold text-brand-700">{results.grade}</div></div>
            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4"><div className="text-sm text-slate-500 mb-1">UCAS Points</div><div className="text-3xl font-bold text-slate-900">{results.ucasPoints}</div></div>
            {results.nextGradeBoundary && (<div className="bg-amber-50 p-3 rounded-md text-amber-700 text-sm border border-amber-100">Need <strong>{results.nextGradeBoundary.pointsNeeded}</strong> more points for <strong>{results.nextGradeBoundary.grade}</strong>.</div>)}
          </div>
        );
      };

      const LoginScreen = ({ users, onLogin }) => {
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const handleSubmit = (e) => {
          e.preventDefault();
          const user = users.find(u => u.username === username && u.password === password);
          if (user) onLogin(user); else setError('Invalid credentials');
        };
        return (
          <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
            <div className="bg-white border border-slate-200 rounded-2xl shadow-xl w-full max-w-md p-8 relative overflow-hidden">
              <div className="flex justify-center mb-8"><div className="w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center border border-brand-100 shadow-inner text-brand-600"><Lock className="w-8 h-8" /></div></div>
              <h1 className="text-3xl font-bold text-slate-900 text-center mb-8">GradeMaster</h1>
              {error && <div className="bg-red-50 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm">{error}</div>}
              <form onSubmit={handleSubmit} className="space-y-5">
                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="block w-full px-4 py-2 border rounded-lg" placeholder="Username" />
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="block w-full px-4 py-2 border rounded-lg" placeholder="Password" />
                <button type="submit" className="w-full py-2.5 bg-brand-600 hover:bg-brand-700 text-white font-medium rounded-lg shadow-sm">Sign In</button>
              </form>
              <div className="mt-8 text-center text-xs text-slate-400">Environment: {APP_URL}</div>
            </div>
          </div>
        );
      };

      const UserManagement = ({ users, setUsers, currentUser }) => {
        const [view, setView] = useState('list');
        const [editingUser, setEditingUser] = useState(null);
        const [formData, setFormData] = useState({ username: '', password: '', email: '', role: UserRole.TEACHER });
        const [showEmailSent, setShowEmailSent] = useState(null);

        const handleSave = (e) => {
            e.preventDefault();
            const newUser = { id: editingUser ? editingUser.id : generateId(), ...formData };
            if (editingUser) setUsers(prev => prev.map(u => u.id === editingUser.id ? newUser : u));
            else {
              setUsers(prev => [...prev, newUser]);
              setShowEmailSent(newUser);
            }
            setView('list'); setEditingUser(null);
        };

        const triggerMailTo = (user) => {
            const subject = encodeURIComponent("Your GradeMaster Account Credentials");
            const body = encodeURIComponent(`Hello ${user.username},\n\nYour account for GradeMaster has been created.\n\nLogin URL: ${APP_URL}\nUsername: ${user.username}\nPassword: ${user.password}\n\nPlease login and check your allocated courses.\n\nRegards,\nGradeMaster Admin`);
            window.location.href = `mailto:${user.email}?subject=${subject}&body=${body}`;
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text);
            alert("Copied to clipboard!");
        };

        return (
             <div className="space-y-6">
                 {showEmailSent && (
                     <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                         <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 relative overflow-hidden">
                             <div className="flex flex-col items-center text-center">
                                 <div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-6 shadow-inner"><Mail className="w-10 h-10" /></div>
                                 <h3 className="text-2xl font-bold text-slate-900 mb-2">User Created Successfully</h3>
                                 <p className="text-slate-600 mb-6">You can now send the credentials to <strong>{showEmailSent.email}</strong>.</p>
                                 
                                 <div className="w-full bg-slate-50 border border-slate-200 rounded-xl p-5 text-left space-y-3 mb-8">
                                     <div className="flex justify-between border-b border-slate-100 pb-2">
                                         <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Login URL</span>
                                         <span className="text-xs font-mono text-brand-600 truncate ml-4">{APP_URL}</span>
                                     </div>
                                     <div className="flex justify-between"><span className="text-sm text-slate-500">Username</span><span className="text-sm font-bold text-slate-900">{showEmailSent.username}</span></div>
                                     <div className="flex justify-between"><span className="text-sm text-slate-500">Password</span><span className="text-sm font-bold text-slate-900">{showEmailSent.password}</span></div>
                                 </div>

                                 <div className="grid grid-cols-2 gap-4 w-full">
                                     <button onClick={() => triggerMailTo(showEmailSent)} className="py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl flex items-center justify-center"><ExternalLink className="w-4 h-4 mr-2" /> Open Email Client</button>
                                     <button onClick={() => setShowEmailSent(null)} className="py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl">Close</button>
                                 </div>
                             </div>
                         </div>
                     </div>
                 )}

                 <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold text-slate-900">User Management</h2>
                    {view === 'list' && <button onClick={() => { setEditingUser(null); setFormData({ username: '', password: '', email: '', role: UserRole.TEACHER }); setView('form'); }} className="flex items-center px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium"><UserPlus className="w-4 h-4 mr-2" /> Add User</button>}
                </div>

                {view === 'list' ? (
                     <div className="bg-white border rounded-lg shadow-sm overflow-hidden">
                        <table className="min-w-full divide-y divide-slate-200">
                            <thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">User</th><th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email</th><th className="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th></tr></thead>
                            <tbody className="bg-white divide-y divide-slate-200">
                                {users.map(user => (
                                    <tr key={user.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{user.username}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500 italic">{user.email || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onClick={() => { setEditingUser(user); setFormData({ username: user.username, password: user.password, email: user.email || '', role: user.role }); setView('form'); }} className="text-brand-600 mr-4"><Edit2 className="w-4 h-4" /></button>
                                            <button onClick={() => triggerMailTo(user)} className="text-brand-600 mr-4" title="Send Email"><Mail className="w-4 h-4" /></button>
                                            <button onClick={() => { if(confirm('Delete?')) setUsers(prev => prev.filter(u => u.id !== user.id))}} className="text-red-600"><Trash2 className="w-4 h-4" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                     </div>
                ) : (
                    <div className="bg-white border rounded-lg shadow-sm p-8 max-w-2xl mx-auto">
                         <h3 className="text-xl font-bold text-slate-900 mb-6">{editingUser ? 'Edit User' : 'Create New User'}</h3>
                         <form onSubmit={handleSave} className="space-y-5">
                             <div className="grid grid-cols-2 gap-5">
                                 <div><label className="block text-sm font-semibold mb-1.5">Username</label><input type="text" required value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} className="block w-full px-4 py-2 border rounded-xl" /></div>
                                 <div><label className="block text-sm font-semibold mb-1.5">Password</label><input type="text" required value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="block w-full px-4 py-2 border rounded-xl" /></div>
                             </div>
                             <div><label className="block text-sm font-semibold mb-1.5">Email</label><input type="email" required value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="block w-full px-4 py-2 border rounded-xl" placeholder="user@example.com" /></div>
                             <div className="flex justify-end space-x-3 pt-6 border-t"><button type="button" onClick={() => setView('list')} className="px-6 py-2.5 text-slate-600">Cancel</button><button type="submit" className="px-8 py-2.5 bg-brand-600 text-white font-bold rounded-xl flex items-center"><Send className="w-4 h-4 mr-2" /> {editingUser ? 'Update Account' : 'Create & Send Email'}</button></div>
                         </form>
                    </div>
                )}
             </div>
        );
      };

      const App = () => {
        const [users, setUsers] = useState(() => {
            const saved = localStorage.getItem('gm_users');
            return saved ? JSON.parse(saved) : [
                { id: '1', username: 'Frazadmin', password: 'Frazadmin', email: 'admin@grademaster.com', role: UserRole.SUPERUSER },
                { id: '2', username: 'admin', password: 'password', email: 'admin@school.ac.uk', role: UserRole.ADMIN },
                { id: '3', username: 'teacher', password: 'password', email: 'teacher@school.ac.uk', role: UserRole.TEACHER },
            ];
        });

        const [courses, setCourses] = useState(() => {
            const saved = localStorage.getItem('gm_courses');
            return saved ? JSON.parse(saved) : [
                { id: '1', title: 'Year 12 Esports Group A', academicYear: '2024-25', subject: Subject.ESPORTS, qualification: QualificationType.EXTENDED_DIPLOMA, units: sortUnits([ { name: "Unit 1: Introduction to Esports", glh: 60, type: UnitType.INTERNAL, id: 'u1' }, { name: "Unit 2: Esports Skills, Strategies and Analysis", glh: 120, type: UnitType.INTERNAL, id: 'u2' } ]), students: [] },
            ];
        });

        useEffect(() => { localStorage.setItem('gm_users', JSON.stringify(users)); }, [users]);
        useEffect(() => { localStorage.setItem('gm_courses', JSON.stringify(courses)); }, [courses]);

        const [currentUser, setCurrentUser] = useState(null);
        const [activeView, setActiveView] = useState('dashboard');
        const [selectedCourseId, setSelectedCourseId] = useState(null);

        const handleUpdateCourse = (id, updates) => setCourses(prev => prev.map(c => c.id === id ? { ...c, ...updates } : c));
        const handleCreateCourse = (courseData) => setCourses(prev => [...prev, { id: generateId(), students: [], ...courseData }]);
        const handleDeleteCourse = (id) => setCourses(prev => prev.filter(c => c.id !== id));

        if (!currentUser) return <LoginScreen users={users} onLogin={setCurrentUser} />;

        if (selectedCourseId) {
            const course = courses.find(c => c.id === selectedCourseId);
            return (
                <div className="min-h-screen bg-slate-50">
                    <header className="bg-white border-b h-16 flex items-center px-8 justify-between sticky top-0 z-20"><div className="flex items-center space-x-3"><div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold">G</div><span className="font-bold">GradeMaster</span></div><div className="text-sm font-medium px-3 py-1 bg-slate-100 rounded-full">{currentUser.username}</div></header>
                    <main className="max-w-7xl mx-auto px-8 py-8"><StudentManager course={course} onBack={() => setSelectedCourseId(null)} onUpdateCourse={handleUpdateCourse} currentUser={currentUser} /></main>
                </div>
            );
        }

        return (
            <div className="min-h-screen bg-slate-50">
                <header className="bg-white border-b h-16 flex items-center px-8 justify-between sticky top-0 z-20 shadow-sm">
                    <div className="flex items-center space-x-3"><div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold">G</div><span className="font-bold">GradeMaster</span></div>
                    <nav className="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                        <button onClick={() => setActiveView('dashboard')} className={`px-4 py-1.5 text-sm font-medium rounded-md ${activeView === 'dashboard' ? 'bg-white shadow-sm' : 'text-slate-50'}`}>Dashboard</button>
                        <button onClick={() => setActiveView('builder')} className={`px-4 py-1.5 text-sm font-medium rounded-md ${activeView === 'builder' ? 'bg-white shadow-sm' : 'text-slate-500'}`}>Course Builder</button>
                        {currentUser.role === UserRole.SUPERUSER && <button onClick={() => setActiveView('users')} className={`px-4 py-1.5 text-sm font-medium rounded-md ${activeView === 'users' ? 'bg-white shadow-sm' : 'text-slate-500'}`}>Users</button>}
                    </nav>
                    <button onClick={() => setCurrentUser(null)} className="p-2 text-slate-400 hover:text-slate-600"><LogOut className="w-5 h-5" /></button>
                </header>
                <main className="max-w-7xl mx-auto px-8 py-8">
                    {activeView === 'dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {courses.map(course => (
                                <div key={course.id} onClick={() => setSelectedCourseId(course.id)} className="bg-white border rounded-xl shadow-sm hover:shadow-lg p-6 cursor-pointer"><h3 className="text-xl font-bold mb-1">{course.title}</h3><p className="text-sm text-slate-500">{course.subject}</p></div>
                            ))}
                        </div>
                    )}
                    {activeView === 'builder' && <CourseManager courses={courses} onUpdate={handleUpdateCourse} onCreate={handleCreateCourse} onDelete={handleDeleteCourse} currentUser={currentUser} />}
                    {activeView === 'users' && <UserManagement users={users} setUsers={setUsers} currentUser={currentUser} />}
                </main>
            </div>
        );
      };

      const StudentManager = ({ course, onBack, onUpdateCourse, currentUser }) => {
        const [view, setView] = useState('list');
        const [activeStudent, setActiveStudent] = useState(null);
        const [showAddStudentModal, setShowAddStudentModal] = useState(false);
        const [newStudentName, setNewStudentName] = useState('');

        const handleAddStudentSubmit = (e) => {
             e.preventDefault();
             if (newStudentName.trim()) {
                 const newStudent = { id: generateId(), name: newStudentName.trim(), grades: {} };
                 onUpdateCourse(course.id, { students: [...(course.students || []), newStudent] });
                 setNewStudentName(''); setShowAddStudentModal(false);
             }
        };

        if (view === 'editor' && activeStudent) {
            const unitsWithGrades = mergeUnitsAndGrades(course.units, activeStudent.grades, activeStudent.lockedGrades);
            const sortedUnits = sortUnits(unitsWithGrades);
            const results = calculateQualification(unitsWithGrades, course.qualification);
            const availableGrades = getAvailableGrades(course.qualification);
            return (
                <div className="flex flex-col h-[calc(100vh-100px)]"> 
                    <div className="bg-white border-b shadow-sm p-4"><button onClick={() => setView('list')} className="text-slate-500 flex items-center mb-4"><ArrowLeft className="w-4 h-4 mr-1" /> Back</button><h2 className="text-2xl font-bold">{activeStudent.name}</h2></div>
                    <div className="flex-1 overflow-y-auto bg-slate-50 p-6">
                        <div className="max-w-6xl mx-auto grid grid-cols-3 gap-6">
                            <div className="col-span-2 bg-white border rounded-xl overflow-hidden">
                                <table className="min-w-full divide-y">
                                    <thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left">Unit</th><th className="px-6 py-3 text-left">Grade</th></tr></thead>
                                    <tbody className="divide-y">
                                        {sortedUnits.map(unit => (
                                            <tr key={unit.id} className="hover:bg-slate-50">
                                                <td className="px-6 py-4 font-medium">{unit.name}</td>
                                                <td className="px-6 py-4">
                                                    <select value={unit.grade} onChange={(e) => {
                                                        const updatedStudent = { ...activeStudent, grades: { ...activeStudent.grades, [unit.id]: e.target.value } };
                                                        setActiveStudent(updatedStudent);
                                                        onUpdateCourse(course.id, { students: course.students.map(s => s.id === activeStudent.id ? updatedStudent : s) });
                                                    }} className="block w-full border-slate-300 rounded-md">{availableGrades.map(g => <option key={g} value={g}>{g}</option>)}</select>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div><ResultsPanel results={results} /></div>
                        </div>
                    </div>
                </div>
            );
        }
        return (
            <div>
                 {showAddStudentModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
                        <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                            <h3 className="text-lg font-bold mb-4">Add Student</h3>
                            <form onSubmit={handleAddStudentSubmit}>
                                <input type="text" autoFocus required value={newStudentName} onChange={(e) => setNewStudentName(e.target.value)} className="w-full px-3 py-2 border rounded-lg mb-4" placeholder="Name" />
                                <div className="flex justify-end space-x-3"><button type="button" onClick={() => setShowAddStudentModal(false)} className="px-4 py-2">Cancel</button><button type="submit" className="px-4 py-2 bg-brand-600 text-white rounded-lg">Add</button></div>
                            </form>
                        </div>
                    </div>
                 )}
                <div className="flex justify-between items-center mb-6"><button onClick={onBack} className="flex items-center text-slate-500"><ArrowLeft className="w-4 h-4 mr-1" /> Back</button><button onClick={() => setShowAddStudentModal(true)} className="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Add Student</button></div>
                <div className="grid grid-cols-3 gap-6">
                    {(course.students || []).map(student => (
                        <div key={student.id} onClick={() => { setActiveStudent(student); setView('editor'); }} className="bg-white border rounded-xl p-5 shadow-sm hover:shadow-md cursor-pointer"><h3 className="font-bold">{student.name}</h3></div>
                    ))}
                </div>
            </div>
        );
      };

      const CourseManager = ({ courses, onUpdate, onCreate, onDelete, currentUser }) => {
        const [view, setView] = useState('list');
        const [editingCourse, setEditingCourse] = useState(null);
        const [formData, setFormData] = useState({ title: '', year: '2024-25', subject: Subject.ESPORTS, qualification: QualificationType.EXTENDED_DIPLOMA, units: [] });
        const handleSave = (e) => { e.preventDefault(); if (editingCourse) onUpdate(editingCourse.id, formData); else onCreate(formData); setView('list'); };
        if (view === 'list') {
            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Course Builder</h2><button onClick={() => { setEditingCourse(null); setFormData({ title: '', year: '2024-25', subject: Subject.ESPORTS, qualification: QualificationType.EXTENDED_DIPLOMA, units: sortUnits(SAMPLE_UNITS_ESPORTS.map(u => ({...u, id: generateId()}))) }); setView('form'); }} className="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm">Add Course</button></div>
                    <div className="bg-white border rounded-xl overflow-hidden">
                        <table className="min-w-full divide-y">
                            <thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left">Title</th><th className="px-6 py-3 text-right">Actions</th></tr></thead>
                            <tbody className="divide-y">
                                {courses.map(c => (
                                    <tr key={c.id} className="hover:bg-slate-50"><td className="px-6 py-4">{c.title}</td><td className="px-6 py-4 text-right"><button onClick={() => { setEditingCourse(c); setFormData(c); setView('form'); }} className="text-brand-600 mr-4">Edit</button><button onClick={() => onDelete(c.id)} className="text-red-600">Delete</button></td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        return (
            <div className="max-w-2xl mx-auto bg-white border p-8 rounded-xl shadow-sm">
                <h3 className="text-xl font-bold mb-6">{editingCourse ? 'Edit' : 'Create'} Course</h3>
                <form onSubmit={handleSave} className="space-y-5">
                    <input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="block w-full border px-4 py-2 rounded-lg" placeholder="Course Title" required />
                    <select value={formData.subject} onChange={e => setFormData({...formData, subject: e.target.value})} className="block w-full border px-4 py-2 rounded-lg">{Object.values(Subject).map(s => <option key={s} value={s}>{s}</option>)}</select>
                    <select value={formData.qualification} onChange={e => setFormData({...formData, qualification: e.target.value})} className="block w-full border px-4 py-2 rounded-lg">{Object.values(QualificationType).map(q => <option key={q} value={q}>{q}</option>)}</select>
                    <div className="flex justify-end space-x-3"><button type="button" onClick={() => setView('list')} className="px-6 py-2">Cancel</button><button type="submit" className="bg-brand-600 text-white px-6 py-2 rounded-lg">Save</button></div>
                </form>
            </div>
        );
      };

      createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>